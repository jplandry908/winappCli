name: Build and Package

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases
  pull-requests: write  # Required for binary size report comments

jobs:
  build-and-package:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Required for build number calculation
    
    - name: Install .NET Core
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x
    
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '24'
    
    # Run the build script which handles building, testing, versioning, npm packaging, and MSIX bundling
    # Skip doc generation in CI - we validate the committed docs separately to detect drift
    - name: Build, test, and package
      id: build
      run: |
        .\scripts\build-cli.ps1 -SkipDocs
        
        # Get version information for release tagging
        $versionJson = Get-Content "version.json" | ConvertFrom-Json
        $baseVersion = $versionJson.version
        $buildNumber = & ".\scripts\get-build-number.ps1"
        $fullVersion = "$baseVersion-prerelease.$buildNumber"
        
        # Export for use in subsequent steps
        echo "version=$fullVersion" >> $env:GITHUB_OUTPUT
        echo "base_version=$baseVersion" >> $env:GITHUB_OUTPUT
        echo "build_number=$buildNumber" >> $env:GITHUB_OUTPUT
    
    # Validate LLM documentation is up-to-date (runs after build so CLI binary exists, but docs weren't regenerated)
    - name: Validate LLM documentation
      run: |
        $FailOnDrift = ("${{ github.event_name }}" -eq "pull_request" -and "${{ github.base_ref }}" -eq "main")
        .\scripts\validate-llm-docs.ps1 -FailOnDrift:$FailOnDrift
    
    # Upload all build artifacts
    - name: Upload test results
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: artifacts/TestResults/*.trx
        if-no-files-found: error
    
    - name: Upload CLI binaries
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: cli-binaries
        path: artifacts/cli/
        if-no-files-found: error
    
    - name: Upload npm package
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: npm-package
        path: artifacts/*.tgz
        if-no-files-found: error

    - name: Upload MSIX packages
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: msix-packages
        path: artifacts/msix-packages/*.msix
        if-no-files-found: error

    # --- Binary size tracking ---
    # Restore baseline sizes from the last main build (for PR comparison)
    - name: Restore size baseline
      if: github.event_name == 'pull_request'
      id: size-baseline
      uses: actions/cache/restore@v4
      with:
        path: size-baseline
        key: binary-size-baseline-no-exact-match
        restore-keys: binary-size-main-

    - name: Measure artifact sizes
      shell: pwsh
      run: |
        $sizes = @{}

        $x64Exe = Get-Item "artifacts/cli/win-x64/winapp.exe" -ErrorAction SilentlyContinue
        $arm64Exe = Get-Item "artifacts/cli/win-arm64/winapp.exe" -ErrorAction SilentlyContinue
        $npmPkg = Get-ChildItem "artifacts/*.tgz" -ErrorAction SilentlyContinue | Select-Object -First 1
        $msixX64 = Get-ChildItem "artifacts/msix-packages/*x64*.msix" -ErrorAction SilentlyContinue | Select-Object -First 1
        $msixArm64 = Get-ChildItem "artifacts/msix-packages/*arm64*.msix" -ErrorAction SilentlyContinue | Select-Object -First 1

        if ($x64Exe) { $sizes["cli-win-x64"] = $x64Exe.Length }
        if ($arm64Exe) { $sizes["cli-win-arm64"] = $arm64Exe.Length }
        if ($npmPkg) { $sizes["npm-package"] = $npmPkg.Length }
        if ($msixX64) { $sizes["msix-x64"] = $msixX64.Length }
        if ($msixArm64) { $sizes["msix-arm64"] = $msixArm64.Length }

        $sizes | ConvertTo-Json | Set-Content "artifacts/binary-sizes.json"

        Write-Host "Current artifact sizes:"
        $sizes.GetEnumerator() | Sort-Object Key | ForEach-Object {
          Write-Host "  $($_.Key): $([math]::Round($_.Value / 1MB, 2)) MB ($($_.Value) bytes)"
        }

    # On main, save current sizes as the baseline for future PRs
    - name: Save size baseline
      if: github.ref == 'refs/heads/main'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path "size-baseline" -Force | Out-Null
        Copy-Item "artifacts/binary-sizes.json" "size-baseline/sizes.json"

    - name: Cache size baseline
      if: github.ref == 'refs/heads/main'
      uses: actions/cache/save@v4
      with:
        path: size-baseline
        key: binary-size-main-${{ github.sha }}

    # On PRs, compare against baseline and post a comment
    - name: Report binary size changes
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          const current = JSON.parse(fs.readFileSync('artifacts/binary-sizes.json', 'utf8'));

          let baseline = {};
          let hasBaseline = false;
          try {
            baseline = JSON.parse(fs.readFileSync('size-baseline/sizes.json', 'utf8'));
            hasBaseline = true;
          } catch (e) {
            core.info('No baseline found (first run or cache expired). Reporting absolute sizes.');
          }

          function formatBytes(bytes) {
            const mb = bytes / (1024 * 1024);
            if (mb >= 1) return `${mb.toFixed(2)} MB`;
            const kb = bytes / 1024;
            return `${kb.toFixed(1)} KB`;
          }

          function formatDelta(curr, base) {
            const delta = curr - base;
            const pct = base > 0 ? ((delta / base) * 100).toFixed(2) : 'N/A';
            const sign = delta > 0 ? '+' : '';
            let icon = ':white_check_mark:';
            if (delta > 0) icon = ':chart_with_upwards_trend:';
            else if (delta < 0) icon = ':chart_with_downwards_trend:';
            return `${icon} ${sign}${formatBytes(delta)} (${sign}${pct}%)`;
          }

          const labels = {
            'cli-win-x64': 'CLI (x64)',
            'cli-win-arm64': 'CLI (ARM64)',
            'npm-package': 'NPM Package',
            'msix-x64': 'MSIX (x64)',
            'msix-arm64': 'MSIX (ARM64)',
          };

          let body = '## Binary Size Report\n\n';

          if (hasBaseline) {
            body += '| Artifact | Baseline | Current | Delta |\n';
            body += '|----------|----------|---------|-------|\n';

            const allKeys = [...new Set([...Object.keys(baseline), ...Object.keys(current)])].sort();
            for (const key of allKeys) {
              const label = labels[key] || key;
              const baseSize = baseline[key] || 0;
              const currSize = current[key] || 0;
              if (currSize === 0 && baseSize === 0) continue;

              const baseStr = baseSize > 0 ? formatBytes(baseSize) : 'N/A';
              const currStr = currSize > 0 ? formatBytes(currSize) : 'N/A';
              const deltaStr = (baseSize > 0 && currSize > 0)
                ? formatDelta(currSize, baseSize)
                : 'N/A';
              body += `| ${label} | ${baseStr} | ${currStr} | ${deltaStr} |\n`;
            }
          } else {
            body += '> **Note:** No baseline found (first run after enabling size tracking). Showing absolute sizes only.\n\n';
            body += '| Artifact | Size |\n';
            body += '|----------|------|\n';
            for (const [key, size] of Object.entries(current).sort()) {
              const label = labels[key] || key;
              body += `| ${label} | ${formatBytes(size)} |\n`;
            }
          }

          body += '\n<!-- binary-size-report -->';

          // Find and update existing comment to avoid spam
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existing = comments.find(c => c.body && c.body.includes('<!-- binary-size-report -->'));

          if (existing) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existing.id,
              body,
            });
            core.info(`Updated existing comment ${existing.id}`);
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
            core.info('Created new size report comment');
          }

  # E2E test for Electron workflow - runs after build completes
  e2e-test:
    runs-on: windows-latest
    needs: build-and-package
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '24'

    - name: Download npm package artifact
      uses: actions/download-artifact@v4
      with:
        name: npm-package
        path: artifacts/npm

    - name: Run E2E Electron test
      run: |
        .\scripts\test-e2e-electron.ps1 -ArtifactsPath "artifacts/npm" -Verbose